{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="payment-container">
    <h2>Оплата заказа #{{ order.id }}</h2>
    <p>Сумма к оплате: <strong>{{ total_price }} {{ currency|upper }}</strong></p>
    
    <form id="payment-form">
        {% csrf_token %}
        <div id="payment-element">
            </div>
        <button id="submit-button" class="btn-pay">Оплатить сейчас</button>
        <div id="payment-message" style="display: none;"></div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // 1. Инициализация Stripe
    const stripe = Stripe('{{ stripe_public_key }}');
    let elements;

    async function initialize() {
        // 2. Вызываем ваше вью payment_intent_view через Django URL
        const response = await fetch("{% url 'create_payment_intent' order.id %}?currency={{ currency }}");
        const data = await response.json();

        if (data.error) {
            const messageEl = document.getElementById("payment-message");
            messageEl.textContent = data.error;
            messageEl.style.display = "block";
            return;
        }

        // 3. Создаем элементы формы, используя полученный clientSecret
        elements = stripe.elements({ clientSecret: data.clientSecret });
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");
    }

    // 4. Обработка нажатия кнопки
    document.querySelector("#payment-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitButton = document.querySelector("#submit-button");
        submitButton.disabled = true;

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: window.location.origin + "{% url 'payment_complete' %}?provider=stripe",
            },
        });

        if (error) {
            const messageEl = document.getElementById("payment-message");
            messageEl.textContent = error.message;
            messageEl.style.display = "block";
            submitButton.disabled = false;
        }
    });

    initialize();
</script>
{% endblock %}