{% extends "base.html" %}
{% load static %}

{% block title %}Оформление заказа{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/catalog/cart_detail.css' %}" />
{% endblock %}

{% block content %}
<div class="cart-page-container">
  <section class="cart-items-list" id="cart-items-section">
    {% if order.orderitem_set.exists %} 
    <div id="items-wrapper">
        {% for oi in order.orderitem_set.all %}
        <div class="cart-item" id="item-row-{{ oi.item.id }}">
          <div class="item-info">
            <h3>{{ oi.item.name }}</h3>
            <p class="item-price-info">
              {{ oi.price_at_purchase }} <span class="currency-code">{{ oi.item.currency }}</span>
            </p>
          </div>

          <div class="quantity-control">
            <button class="btn-qty ajax-btn" data-item-id="{{ oi.item.id }}" data-action="reduce">−</button>
            <span class="qty-num" id="qty-val-{{ oi.item.id }}">{{ oi.quantity }}</span>
            <button class="btn-qty ajax-btn" data-item-id="{{ oi.item.id }}" data-action="add">+</button>
          </div>

          <div class="item-total">
            <button class="ajax-btn remove-btn" data-item-id="{{ oi.item.id }}" data-action="remove">
              Удалить
            </button>
          </div>
        </div>
        {% endfor %}
    </div>

    <div id="cart-tools">
      <a href="{% url 'cart_clear' %}" id="clear-cart-link" class="remove-btn">Очистить корзину</a>
    </div>

    {% else %}
    <div id="empty-cart-message">
    
      <p>В корзине пока ничего нет.</p>
      <a href="{% url 'catalog_shop' %}" id="back-btn">Вернуться в магазин</a>
    </div>
    {% endif %}
  </section>

  <aside class="cart-checkout-sidebar" {% if not order.orderitem_set.exists %}style="display: none;"{% endif %}>
    <h3>Детали заказа</h3>
    
    <div class="promo-code-section">
        <label for="promo-input">Промокод:</label>
        <div class="promo-input-group">
            <input type="text" id="promo-input" placeholder="Введите код" class="promo-input" 
                   value="{{ order.discount.code|default:'' }}">
            <button id="apply-promo-btn">Применить</button>
        </div>
        <small id="promo-message"></small>
    </div>

    <div class="currency-selection" id="currency-area">
        <label for="currency-select">Валюта оплаты:</label>
        <select id="currency-select" class="currency-dropdown"></select>
    </div>
    
    <div id="price-details">
        <p>Сумма: <span id="subtotal-display">{{ subtotal|default:"0" }}</span></p>
        
        <p class="discount-row" id="discount-area" {% if not order.discount %}style="display:none;"{% endif %}>
            Скидка: <span id="discount-amount-display">{{ discount_amount|default:"0" }}</span>
        </p>

        <p id="tax-area">
            Налоги: <span id="tax-amount-display">{{ tax_amount|default:"0" }}</span>
        </p>
        
        <div class="total-row">
            Итого: <span id="total-price-display">{{ total_cost|default:"0" }}</span>
        </div>
    </div>

     <a href="{% url 'checkout' order.id %}" class="btn-buy" id="checkout-button">Оплатить заказ</a>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsSection = document.getElementById('cart-items-section');
    const itemsWrapper = document.getElementById('items-wrapper');
    const sidebar = document.querySelector('.cart-checkout-sidebar');
    const currencySelect = document.getElementById('currency-select');
    const checkoutButton = document.getElementById('checkout-button');
    const applyPromoBtn = document.getElementById('apply-promo-btn');
    const promoInput = document.getElementById('promo-input');
    const promoMessage = document.getElementById('promo-message');

    function updateCurrencyOptions() {
        if (!itemsWrapper || !currencySelect) return;
        const codes = itemsWrapper.querySelectorAll('.currency-code');
        const currencies = new Set();
        codes.forEach(el => {
            const val = el.innerText.trim().toLowerCase();
            if (val) currencies.add(val);
        });

        currencySelect.innerHTML = '';
        if (currencies.size > 0) {
            currencies.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code.toUpperCase();
                currencySelect.appendChild(option);
            });
            updateCheckoutUrl(currencySelect.value);
        } else {
            const area = document.getElementById('currency-area');
            if (area) area.style.display = 'none';
        }
    }

    function updateCheckoutUrl(val) {
        if (!checkoutButton || !val) return;
        const url = new URL(checkoutButton.href, window.location.origin);
        url.searchParams.set('currency', val);
        checkoutButton.href = url.pathname + url.search;
    }

    function showEmptyMessage() {
        itemsSection.innerHTML = `
            <div id="empty-cart-message">
                <p>В корзине пока ничего нет.</p>
                <a href="{% url 'catalog_shop' %}" id="back-btn">Вернуться в магазин</a>
            </div>`;
        if (sidebar) sidebar.style.display = 'none';
    }

    function updateSidebarUI(data) {
        if (!data.success) return;

        const elements = {
            'total-price-display': data.total || data.total_cost,
            'discount-amount-display': data.discount_amount,
            'tax-amount-display': data.tax_amount,
            'subtotal-display': data.subtotal
        };

        for (let id in elements) {
            const el = document.getElementById(id);
            if (el && elements[id] !== undefined) el.innerText = elements[id];
        }

        const discountArea = document.getElementById('discount-area');
        if (discountArea) {
            discountArea.style.display = parseFloat(data.discount_amount) > 0 ? 'block' : 'none';
        }
    }

    currencySelect.addEventListener('change', function() {
        const selectedCurrency = this.value.toUpperCase();

        const orderId = "{{ order.id }}";

        fetch(`/catalog/get_total/${orderId}/${selectedCurrency}/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const totalDisplay = document.getElementById('total-price-display');
                if (totalDisplay) {
                    totalDisplay.innerText = data.total_cost;
                }
                updateSidebarUI(data);
                updateCheckoutUrl(selectedCurrency.toLowerCase());
            } else {
                console.error("Ошибка при пересчете:", data.message);
            }
        })
        .catch(err => console.error("Ошибка сети:", err));
    });

    applyPromoBtn.addEventListener('click', function() {
        const code = promoInput.value.trim();
        if (!code) return;

        fetch(`/pricing/apply_promo/{{ order.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ code: code, currency: currencySelect.value })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateSidebarUI(data)
            } else {
                promoMessage.style.color = 'red';
                promoMessage.innerText = data.message || 'Неверный код';
            }
        })
        .catch(err => console.error("Ошибка:", err));
    });

    itemsSection.addEventListener('click', function(e) {
        const btn = e.target.closest('.ajax-btn');
        const clearLink = e.target.closest('#clear-cart-link');

        if (btn) {
            e.preventDefault();
            const itemId = btn.dataset.itemId;
            const action = btn.dataset.action;
            const currentCurrency = currencySelect ? currencySelect.value : 'rub';

            fetch(`/catalog/cart/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    item_id: itemId,
                    action: action,
                    currency: currentCurrency
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const itemRow = document.getElementById(`item-row-${itemId}`);
                    if (data.item_qty <= 0 || action === 'remove') {
                        if (itemRow) {
                            itemRow.style.opacity = '0';
                            setTimeout(() => {
                                itemRow.remove();
                                updateCurrencyOptions();
                                if (data.total_qty === 0) showEmptyMessage();
                            }, 300);
                        }
                    } else {
                        const qtySpan = document.getElementById(`qty-val-${itemId}`);
                        if (qtySpan) qtySpan.innerText = data.item_qty;
                    }

                    const totalDisplay = document.getElementById('total-price-display');
                    if (totalDisplay) totalDisplay.innerText = data.total_cost;

                    updateSidebarUI(data)
                }
            });
        }

        if (clearLink) {
            e.preventDefault();
            fetch(clearLink.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showEmptyMessage();
                    const badge = document.querySelector('.cart-count-badge');
                    if (badge) badge.innerText = '0';
                }
            });
        }
    });
    updateCurrencyOptions();
});
</script>
{% endblock %}